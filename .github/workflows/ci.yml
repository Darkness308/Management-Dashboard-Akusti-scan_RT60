name: CI/CD Pipeline

on:
  push:
    branches: [ main, claude/**, feature/** ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” Lint code
      run: npm run lint || true
      continue-on-error: true

    - name: ğŸ—ï¸ Build application
      id: build
      run: npm run build
      continue-on-error: true

    - name: ğŸ“Š Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: dist-${{ matrix.node-version }}
        path: dist/
        retention-days: 7

    - name: âŒ Build failed - Create issue
      if: failure() && steps.build.outcome == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ”´ Build Failed - Auto-Fix Required',
            body: `## Build Failure Report

            **Branch:** \`${context.ref}\`
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Workflow:** ${context.workflow}
            **Job:** ${context.job}
            **Node Version:** ${{ matrix.node-version }}

            ### Action Required
            This issue was automatically created because the build failed.

            The Self-Healing workflow will attempt to fix this automatically.

            ### Labels
            - \`build-failure\`
            - \`auto-fix-needed\`
            `,
            labels: ['build-failure', 'auto-fix-needed', 'automated']
          });

          console.log('Created issue:', issue.data.number);

    - name: âœ… Build Success
      if: success()
      run: echo "âœ… Build completed successfully!"
